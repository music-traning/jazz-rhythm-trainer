<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JAZZ RHYTHM TRAINER v5.4 (First Setup)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700;900&family=Noto+Sans+JP:wght@400;700&display=swap');

        :root {
            --bg: #0d0d10; --panel: #1a1a20; --text: #e0e0e0;
            --accent: #4cc9f0; --accent-dim: rgba(76, 201, 240, 0.2);
            --p1: #4cc9f0; --p2: #4895ef; --p3: #f72585; --p4: #b5179e; --p5: #ffd60a;
        }

        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Noto Sans JP', sans-serif; color: var(--text); touch-action: none; height: 100vh; -webkit-tap-highlight-color: transparent; }
        
        /* UTILS */
        body.playing .hide-on-play { display: none !important; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        /* HEADER */
        header {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(26, 26, 32, 0.95); backdrop-filter: blur(5px);
            border-bottom: 1px solid #333; z-index: 110;
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px; box-sizing: border-box;
        }
        .brand { font-family: 'Roboto Mono'; font-weight: 700; color: var(--accent); letter-spacing: 1px; }

        /* CANVAS & GAME */
        #visualizer-area { position: relative; width: 100%; height: 100%; overflow: hidden; background: radial-gradient(circle at 50% 50%, #1f1f25 0%, #000 100%); }
        canvas#gameCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* FOOTER */
        #app-footer {
            position: absolute; bottom: 10px; width: 100%; text-align: center;
            font-family: 'Roboto Mono'; font-size: 0.7rem; color: #555; z-index: 150; pointer-events: none;
        }
        #app-footer a { color: #777; text-decoration: none; pointer-events: auto; }

        /* MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); backdrop-filter: blur(8px);
            z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .modal-box {
            background: var(--panel); width: 95%; max-width: 500px; max-height: 85vh;
            border-left: 4px solid var(--accent); border-radius: 4px;
            padding: 20px; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            display: flex; flex-direction: column;
        }
        .modal-box h2 { margin-top: 0; font-family: 'Roboto Mono'; color: var(--accent); border-bottom: 1px solid #444; padding-bottom: 10px; font-size: 1.2rem; }
        .modal-box p { line-height: 1.6; color: #ccc; font-size: 0.85rem; margin-bottom: 15px; }

        /* CALIBRATION SPECIFIC */
        #calib-visual {
            width: 100px; height: 100px; border-radius: 50%; border: 4px solid #333; margin: 20px auto;
            display: flex; justify-content: center; align-items: center; font-family: 'Roboto Mono'; font-size: 1.5rem; color: #fff;
            transition: background 0.1s;
        }
        #calib-visual.flash { background: var(--accent); color: #000; box-shadow: 0 0 20px var(--accent); }
        .calib-val { font-size: 2rem; font-weight: bold; color: var(--accent); font-family: 'Roboto Mono'; text-align: center; margin-bottom: 10px; }

        /* TITLE SCREEN */
        #title-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 200;
            background: radial-gradient(circle, #1a1a2e 0%, #000000 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        .title-logo { font-family: 'Roboto Mono'; font-size: 3rem; font-weight: 900; color: var(--accent); text-shadow: 0 0 20px var(--accent); margin-bottom: 5px; text-align: center; line-height: 1; }
        .title-sub { font-family: 'Roboto Mono'; color: #666; margin-bottom: 30px; letter-spacing: 4px; font-size: 0.9rem; }
        .lang-btn {
            background: transparent; border: 1px solid #555; color: #fff; padding: 15px 40px; margin: 8px;
            font-family: 'Roboto Mono'; font-size: 1rem; cursor: pointer; border-radius: 4px; transition: 0.2s; width: 200px;
        }
        .lang-btn:hover { background: var(--accent); color: #000; border-color: var(--accent); box-shadow: 0 0 15px var(--accent); }
        /* Disable interaction on title until calibration is done/dismissed if needed, or just let modal block it */

        /* LESSON LIST */
        #lesson-list { flex: 1; overflow-y: auto; padding-right: 5px; }
        .phase-header { margin-top: 20px; margin-bottom: 5px; font-size: 0.75rem; color: #888; border-bottom: 1px solid #333; padding-bottom: 2px; font-family: 'Roboto Mono'; font-weight: bold; text-transform: uppercase; }
        .lesson-card {
            background: #25252e; margin-bottom: 8px; padding: 12px; border-radius: 6px;
            border: 1px solid #333; transition: 0.2s; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .lesson-card:hover { border-color: var(--accent); background: #2a2a35; }
        .lesson-card.locked { opacity: 0.3; pointer-events: none; filter: grayscale(1); border-style: dashed; }
        
        .p1 .lvl-badge { color: var(--p1); border-color: var(--p1); }
        .p2 .lvl-badge { color: var(--p2); border-color: var(--p2); }
        .p3 .lvl-badge { color: var(--p3); border-color: var(--p3); }
        .p4 .lvl-badge { color: var(--p4); border-color: var(--p4); }
        .p5 .lvl-badge { color: var(--p5); border-color: var(--p5); box-shadow: 0 0 5px var(--p5); }

        .lvl-badge { font-size: 0.75rem; padding: 2px 8px; border: 1px solid #555; border-radius: 4px; background: #1a1a1a; margin-right: 12px; font-family: 'Roboto Mono'; min-width: 40px; text-align: center; }
        .status-badge { font-size: 0.6rem; padding: 3px 8px; border-radius: 10px; background: #111; color: #555; font-weight: bold; }
        .status-badge.passed { color: var(--accent); background: var(--accent-dim); }

        /* UI ELEMENTS */
        .btn { background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 6px 14px; cursor: pointer; font-weight: bold; border-radius: 4px; font-size: 0.85rem; transition: 0.2s; }
        .btn:hover { background: var(--accent); color: #000; }
        .btn-main { background: var(--accent); color: #121214; width: 100%; padding: 12px; font-size: 1rem; margin-top: 10px; }
        .btn-demo { background: transparent; border: 1px solid #aaa; color: #aaa; width: 100%; padding: 10px; margin-top: 5px; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-demo:hover { background: #333; color: #fff; border-color: #fff; }
        .btn-demo.playing { background: #f05; color: #fff; border-color: #f05; animation: pulse 1s infinite; }
        .btn-reset { display: block; width: 100%; background: #200; color: #f55; border: 1px solid #400; padding: 10px; margin-top: 20px; font-size: 0.8rem; cursor: pointer; border-radius: 4px; }
        .btn-secondary { background: #333; color: #ccc; border: 1px solid #555; width: 100%; padding: 10px; margin-top: 10px; cursor: pointer; border-radius: 4px; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* HUD & FEEDBACK */
        #countdown-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 50; pointer-events: none; }
        #countdown-text { font-size: 8rem; font-weight: 900; color: #fff; text-shadow: 0 0 30px var(--accent); font-family: 'Roboto Mono'; opacity: 0; }
        .count-anim { animation: countPop 0.4s ease-out forwards; }
        @keyframes countPop { 0% { opacity:0; transform:scale(2); } 50% { opacity:1; transform:scale(1); } 100% { opacity:0; transform:scale(0.8); } }
        
        #hud { position: absolute; top: 70px; right: 20px; text-align: right; pointer-events: none; }
        #feedback-float { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; font-weight: 900; opacity: 0; pointer-events: none; text-shadow: 0 0 10px #000; z-index: 20; white-space: nowrap; }
        
        .big-grade { font-size: 5rem; font-weight: 900; margin: 10px 0; font-family: 'Roboto Mono'; line-height: 1; }
        .grade-S { color: var(--p5); text-shadow: 0 0 20px var(--p5); }
        .grade-A { color: var(--accent); }
        .grade-B { color: #fff; }
        .grade-F { color: #555; }

        /* STATS */
        #chart-container { width: 100%; height: 220px; margin-bottom: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; box-sizing: border-box; }
        .briefing-tag { display: inline-block; background: #333; color: #aaa; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-bottom: 5px; margin-right: 5px; }
    </style>
</head>
<body>

    <div id="title-screen">
        <div class="title-logo">JAZZ RHYTHM<br>TRAINER</div>
        <div class="title-sub">GOD TIER EDITION</div>
        
        <button class="lang-btn" onclick="setLang('ja')">üáØüáµ START (JP)</button>
        <button class="lang-btn" onclick="setLang('en')">üá∫üá∏ START (EN)</button>

        <div style="position:absolute; bottom:20px; font-size:0.7rem; color:#666; font-family:'Roboto Mono';">
            &copy; 2026 buro | <a href="https://note.com/jazzy_begin" target="_blank" style="color:#888;">note.com/jazzy_begin</a>
        </div>
    </div>

    <header class="hide-on-play" style="display:none;" id="main-header">
        <div class="brand">JRT <span style="font-size:0.6em; color:#666;">v5.4</span></div>
        <div>
            <button class="btn" id="btn-calib">üîß CALIB</button>
            <button class="btn" id="btn-stats">üìä STATS</button>
            <button class="btn" id="btn-help">?</button>
        </div>
    </header>

    <div id="visualizer-area">
        <canvas id="gameCanvas"></canvas>
        <div id="countdown-overlay"><div id="countdown-text"></div></div>
        <div id="feedback-float"></div>
        <div id="hud">
            <div id="hud-status" style="font-family:'Roboto Mono'; color:var(--accent); font-size:0.8rem;">WAITING...</div>
            <div id="hud-time" style="font-size:1.5rem; font-weight:bold; font-family:'Roboto Mono';">00:00</div>
        </div>
    </div>

    <div id="app-footer" class="hide-on-play" style="display:none;">
        &copy; 2026 buro | <a href="https://note.com/jazzy_begin" target="_blank">note.com/jazzy_begin</a>
    </div>

    <div id="modal-welcome" class="modal-overlay">
        <div class="modal-box" style="text-align:center;">
            <h2 style="color:#fff; border:none;">INITIAL SETUP</h2>
            <div style="text-align:left; font-size:0.85rem; margin-bottom:20px; background:#222; padding:15px; border-radius:6px;">
                <div style="margin-bottom:10px;">
                    <strong style="color:var(--accent);">„ÄêÂøÖÈ†à„ÄëÈÅÖÂª∂Ë™øÊï¥</strong><br>
                    Ê≠£Á¢∫„Å™„É™„Ç∫„É†Âà§ÂÆö„ÅÆ„Åü„ÇÅ„ÄÅÊúÄÂàù„Å´Ë™øÊï¥„ÇíË°å„ÅÑ„Åæ„Åô„ÄÇ<br>‰∏ã„ÅÆ„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶ÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                </div>
                <div style="border-top:1px solid #444; padding-top:10px; color:#aaa;">
                    <strong style="color:#fff;">[REQUIRED] Calibration</strong><br>
                    Let's calibrate your audio latency first.<br>Tap the button below to start.
                </div>
            </div>
            <button class="btn btn-main" onclick="startCalibrationFromWelcome()">üîß START SETUP (Ë®≠ÂÆöÈñãÂßã)</button>
            <button class="btn" style="background:none; border:none; color:#555; font-size:0.8rem; margin-top:10px;" onclick="closeWelcome()">SKIP („Çπ„Ç≠„ÉÉ„Éó)</button>
        </div>
    </div>

    <div id="modal-menu" class="modal-overlay">
        <div class="modal-box">
            <h2 id="menu-title">CURRICULUM</h2>
            <p id="menu-desc">...</p>
            <div id="lesson-list"></div>
            <button class="btn-reset" id="btn-reset-data">üóë RESET DATA</button>
        </div>
    </div>

    <div id="modal-calibration" class="modal-overlay">
        <div class="modal-box" style="text-align:center;">
            <h2 style="text-align:center;">CALIBRATION</h2>
            <p style="text-align:center; font-size:0.8rem; color:#aaa;">
                „É™„Ç∫„É†„Å´Âêà„Çè„Åõ„Å¶ÁîªÈù¢„Çí„Çø„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ<br>Tap to the rhythm.
            </p>
            <div id="calib-visual">TAP</div>
            <div style="margin:20px 0;">
                <div style="font-size:0.8rem; color:#888;">OFFSET (LATENCY)</div>
                <div class="calib-val"><span id="calib-offset-val">60</span><span style="font-size:1rem; color:#555;">ms</span></div>
            </div>
            <button class="btn btn-main" onclick="saveCalibration()">SAVE & CLOSE</button>
            <button class="btn btn-secondary" onclick="cancelCalibration()">CANCEL</button>
        </div>
    </div>

    <div id="modal-briefing" class="modal-overlay">
        <div class="modal-box">
            <h2 id="brief-title">LESSON X</h2>
            <div>
                <span class="briefing-tag">BPM: <span id="brief-bpm">0</span></span>
                <span class="briefing-tag">SWING: <span id="brief-swing">0%</span></span>
            </div>
            <div style="margin-top:15px; color:#aaa; font-size:0.8rem;">OBJECTIVE</div>
            <p id="brief-obj" style="font-weight:bold; color:#fff;">...</p>
            <div style="color:#aaa; font-size:0.8rem;">ADVICE</div>
            <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:4px; margin-bottom:15px; border-left:2px solid #fff;">
                <p id="brief-advice" style="margin:0; font-size:0.9rem;">...</p>
            </div>
            <button class="btn btn-demo" id="btn-play-demo">üîä DEMO</button>
            <button class="btn btn-main" id="btn-start-session">START</button>
            <button class="btn" style="background:none; border:none; color:#666; width:100%; margin-top:5px;" id="btn-cancel-brief">CANCEL</button>
        </div>
    </div>

    <div id="modal-result" class="modal-overlay">
        <div class="modal-box" style="text-align:center;">
            <div style="font-size:0.8rem; color:#888; letter-spacing:2px;">RESULT</div>
            <div class="big-grade" id="res-grade">-</div>
            <div id="res-msg" style="font-weight:bold; margin-bottom:20px; color:#fff;">-</div>
            <div style="background:#222; padding:15px; border-radius:8px; text-align:left; margin-bottom:15px; font-family:'Roboto Mono';">
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #333; padding-bottom:5px;">
                    <span>TIMING</span><span id="res-bias">0ms</span>
                </div>
                <div style="display:flex; justify-content:space-between; padding-top:5px;">
                    <span>STABILITY</span><span id="res-sd">¬±0ms</span>
                </div>
            </div>
            <button class="btn btn-main" id="btn-next">NEXT</button>
        </div>
    </div>

    <div id="modal-stats" class="modal-overlay">
        <div class="modal-box">
            <h2 id="stats-title">STATS</h2>
            <div id="chart-container"><canvas id="statsChart"></canvas></div>
            <p style="font-size:0.75rem; color:#888;">(+) Late / (-) Fast</p>
            <button class="btn btn-main" id="close-stats">CLOSE</button>
        </div>
    </div>

    <div id="modal-help" class="modal-overlay">
        <div class="modal-box">
            <h2 id="help-title">HELP</h2>
            <div id="help-content"></div>
            <button class="btn btn-main" id="close-help">CLOSE</button>
        </div>
    </div>

   <script>
        // --- 1. LANGUAGE & TEXT ---
        let lang = 'ja';
        const TEXT = {
            ja: {
                menuTitle: "„Ç´„É™„Ç≠„É•„É©„É† (50ÊÆµÈöé)",
                menuDesc: "Lv.1-20„ÅØÂü∫Á§éÔºàStraightÔºâ„ÄÅLv.21„Åã„Çâ„Ç∏„É£„Ç∫ÔºàSwingÔºâ„Åß„Åô„ÄÇÁÑ¶„Çâ„ÅöÈÄ≤„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ",
                reset: "üóë „Çª„Éº„Éñ„Éá„Éº„Çø„ÇíÊ∂àÂéª",
                demo: "üîä „ÅäÊâãÊú¨ (DEMO)", stopDemo: "‚èπ ÂÅúÊ≠¢",
                start: "„Çπ„Çø„Éº„Éà", cancel: "„ÇÇ„Å©„Çã", next: "Ê¨°„ÅÆ„É¨„ÉÉ„Çπ„É≥", retry: "„ÇÇ„ÅÜ‰∏ÄÂ∫¶", menu: "„É°„Éã„É•„Éº„Å∏",
                statsTitle: "„É™„Ç∫„É†ÂàÜÊûê",
                helpTitle: "Êìç‰ΩúË™¨Êòé",
                helpContent: `
                    <p><strong>‚òÖ Âü∫Êú¨Êìç‰Ωú</strong><br>
                    <span style="color:#f72585;">‚óè ‰∏ä (Pink)</span>: [‚Üë]„Ç≠„Éº or [X] or ‰∏äÂçäÂàÜ„Çø„ÉÉ„Éó<br>
                    <span style="color:#4cc9f0;">‚óè ‰∏ã (Blue)</span>: [‚Üì]„Ç≠„Éº or [Z] or ‰∏ãÂçäÂàÜ„Çø„ÉÉ„Éó</p>
                    <hr style="border-color:#333;">
                    <p><strong>1. ÂÜÜÈÅãÂãï</strong><br>„É™„Ç∫„É†„Çí„ÄåÁÇπ„Äç„Åß„ÅØ„Å™„Åè„ÄåÂÜÜ„ÅÆÂë®Êúü„Äç„ÅßÊçâ„Åà„Åæ„Åô„ÄÇ</p>
                    <p><strong>2. Gap (ÁÑ°Èü≥)</strong><br>Lv.30‰ª•Èôç„ÄÅ„Ç¨„Ç§„ÉâÈü≥„ÅåÊ∂à„Åà„Çã„ÄåGap„Äç„ÅåÁôªÂ†¥„Åó„Åæ„Åô„ÄÇ</p>
                    <p><strong>3. ÊßãÊàê</strong><br>Lv.1-20: Straight (ÂùáÁ≠â)<br>Lv.21-50: Swing (3ÈÄ£Á¨¶)</p>
                    <hr style="border-color:#333;">
                    <p><strong>4. ÈÅÖÂª∂Ë™øÊï¥ (Calibration)</strong><br>
                    Èü≥„Åå„Ç∫„É¨„Å¶ÊÑü„Åò„ÇãÂ†¥Âêà„ÅØ„ÄÅÁîªÈù¢‰∏äÈÉ®„ÅÆ [üîß CALIB] „Éú„Çø„É≥„Åã„Çâ„ÅÑ„Å§„Åß„ÇÇË™øÊï¥ÂèØËÉΩ„Åß„Åô„ÄÇ</p>
                `,
                resetConfirm: "Ë®òÈå≤„ÇíÂÖ®Ê∂àÂéª„Åó„Åæ„Åô„ÅãÔºü",
                phases: [
                    "PHASE 1: Âü∫Á§é (Straight Basics)", 
                    "PHASE 2: „Ç∞„É´„Éº„É¥ (Straight Groove)", 
                    "PHASE 3: „Çπ„Ç§„É≥„Ç∞ (Swing Entry)", 
                    "PHASE 4: „ÉÜ„ÇØ„Éã„ÉÉ„ÇØ (Advanced)", 
                    "PHASE 5: Á•û„ÅÆÈ†òÂüü (GOD TIER)"
                ]
            },
            en: {
                menuTitle: "CURRICULUM (50 STEPS)",
                menuDesc: "Lv.1-20 Straight. Lv.21+ Swing. Take your time.",
                reset: "üóë RESET SAVE DATA",
                demo: "üîä PLAY DEMO", stopDemo: "‚èπ STOP",
                start: "START", cancel: "BACK", next: "NEXT LESSON", retry: "RETRY", menu: "MENU",
                statsTitle: "STATISTICS",
                helpTitle: "MANUAL",
                helpContent: `
                    <p><strong>‚òÖ CONTROLS</strong><br>
                    <span style="color:#f72585;">‚óè High</span>: [UP] / [X] / Top Screen<br>
                    <span style="color:#4cc9f0;">‚óè Low</span>: [DOWN] / [Z] / Bottom Screen</p>
                    <hr style="border-color:#333;">
                    <p><strong>Structure</strong><br>Lv.1-20: Straight (Even)<br>Lv.21-50: Swing (Triplet)</p>
                    <hr style="border-color:#333;">
                    <p><strong>Calibration</strong><br>
                    Audio lag? Tap the [üîß CALIB] button at the top to adjust latency anytime.</p>
                `,
                resetConfirm: "Delete all progress?",
                phases: [
                    "PHASE 1: BASICS (STRAIGHT)", 
                    "PHASE 2: GROOVE (STRAIGHT)", 
                    "PHASE 3: SWING ENTRY", 
                    "PHASE 4: ADVANCED", 
                    "PHASE 5: GOD TIER"
                ]
            }
        };

        // --- 2. LESSON DATA (50 LEVELS) ---
        // --- 2. LESSON DATA (50 LEVELS) ---
        const LESSON_DATA = [
            // --- PHASE 1: BASICS (Lv.1-10) ---
            { id: 1, p:1, bpm: 60, r:0, s:0.18, d:8,  snd:'click-4', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"ÈºìÂãï 60",s:"4ÂàÜÈü≥Á¨¶",o:"„É™„Ç∫„É†„ÅÆÂéüÁÇπ„ÄÇ",a:"„ÇÜ„Å£„Åè„ÇäÂæÖ„Å§Á∑¥Áøí„ÄÇÂÜÜ„ÇíÊèè„Åè„Çà„ÅÜ„Å´„ÄÇ"}, en:{t:"Pulse 60",s:"Quarter",o:"The Origin.",a:"Wait for it. Draw a circle."} },
            { id: 2, p:1, bpm: 70, r:0, s:0.17, d:8,  snd:'click-4', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"ÈºìÂãï 70",s:"4ÂàÜÈü≥Á¨¶",o:"Â∞ë„ÅóÊ≠©„ÅèÈÄüÂ∫¶„ÄÇ",a:"„ÇØ„É™„ÉÉ„ÇØ„Å®ÂÆåÂÖ®„Å´Èáç„Å™„ÇãÊÑüË¶ö„Çí„ÄÇ"}, en:{t:"Pulse 70",s:"Quarter",o:"Walking pace.",a:"Overlap perfectly."} },
            { id: 3, p:1, bpm: 80, r:0, s:0.16, d:8,  snd:'click-4', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"ÈºìÂãï 80",s:"4ÂàÜÈü≥Á¨¶",o:"Ê®ôÊ∫ñ„ÉÜ„É≥„Éù„ÄÇ",a:"„É™„É©„ÉÉ„ÇØ„Çπ„Åó„Å¶„ÄÇËÇ©„ÅÆÂäõ„ÇíÊäú„ÅÑ„Å¶„ÄÇ"}, en:{t:"Pulse 80",s:"Quarter",o:"Standard.",a:"Relax your shoulders."} },
            { id: 4, p:1, bpm: 90, r:0, s:0.15, d:8,  snd:'click-4', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"ÈºìÂãï 90",s:"4ÂàÜÈü≥Á¨¶",o:"Â∞ë„ÅóÂâçÈÄ≤„Åô„ÇãÊÑüË¶ö„ÄÇ",a:"Ëµ∞„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´Ê≥®ÊÑè„ÄÇ"}, en:{t:"Pulse 90",s:"Quarter",o:"Moving forward.",a:"Don't rush."} },
            { id: 5, p:1, bpm: 60, r:0, s:0.15, d:8,  snd:'click-8', pat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0], ja:{t:"ÂàÜÂâ≤ 60",s:"8ÂàÜÈü≥Á¨¶",o:"Èü≥„ÇíÂçäÂàÜ„Å´Ââ≤„Çã„ÄÇ",a:"„Äå„Çø„Ç´„Çø„Ç´„Äç„Å®ÂùáÁ≠â„Å´„ÄÇË∑≥„Å≠„Åæ„Åõ„Çì„ÄÇ"}, en:{t:"Split 60",s:"8th Note",o:"Even split.",a:"Straight 'Ta-Ka'. No bounce."} },
            { id: 6, p:1, bpm: 70, r:0, s:0.14, d:12, snd:'click-8', pat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0], ja:{t:"ÂàÜÂâ≤ 70",s:"8ÂàÜÈü≥Á¨¶",o:"ÂÆâÂÆö„Åó„ÅüÈÄ£Êâì„ÄÇ",a:"ÊâãÈ¶ñ„ÇíÊüî„Çâ„Åã„Åè‰Ωø„Å£„Å¶„ÄÇ"}, en:{t:"Split 70",s:"8th Note",o:"Steady flow.",a:"Soft wrists."} },
            { id: 7, p:1, bpm: 80, r:0, s:0.14, d:12, snd:'click-8', pat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0], ja:{t:"ÂàÜÂâ≤ 80",s:"8ÂàÜÈü≥Á¨¶",o:"8„Éì„Éº„Éà„ÅÆÂü∫Á§é„ÄÇ",a:"„Ç¢„ÉÉ„Éó„Çπ„Éà„É≠„Éº„ÇØÔºà‰∏ä„Åí„ÇãÂãï‰ΩúÔºâ„ÇíÊÑèË≠ò„ÄÇ"}, en:{t:"Split 80",s:"8th Note",o:"8-beat base.",a:"Focus on up-stroke."} },
            { id: 8, p:1, bpm: 60, r:0, s:0.14, d:8,  snd:'click-4', pat:[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0], ja:{t:"Á©∫Èñì 60",s:"2ÂàÜÈü≥Á¨¶",o:"ÂæÖ„Å§ÂãáÊ∞ó„ÄÇ",a:"Èü≥„ÅÆÈï∑„ÅïÔºà‰ΩôÈüªÔºâ„ÇíÊÑü„Åò„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"}, en:{t:"Space 60",s:"Half Note",o:"Wait.",a:"Feel the sustain."} },
            { id: 9, p:1, bpm: 60, r:0, s:0.13, d:8,  snd:'click-up-str', pat:[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0], ja:{t:"Ë£èÊãç 60",s:"Ë£èÊâì„Å°",o:"„Äå„É≥„Éª„Çø„Äç„ÇíÊÑü„Åò„Çã„ÄÇ",a:"‰ºëÁ¨¶„ÇíÊºîÂ•è„Åô„Çã„Å§„ÇÇ„Çä„Åß„ÄÇ"}, en:{t:"Upbeat 60",s:"Off-beat",o:"Feel the 'And'.",a:"Play the rest."} },
            { id: 10, p:1, bpm: 80, r:0, s:0.13, d:12, snd:'click-gap-4', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"P1‰øÆ‰∫ÜÊ§úÂÆö",s:"Gap 4",o:"„Ç¨„Ç§„Éâ„ÅåÊ∂à„Åà„Åæ„Åô„ÄÇ",a:"ÂøÉ„ÅÆ„É°„Éà„É≠„Éé„Éº„É†„Çí‰ø°„Åò„Å¶„ÄÇ"}, en:{t:"P1 Exam",s:"Gap 4",o:"Guide vanishes.",a:"Trust your inner clock."} },

            // --- PHASE 2: GROOVE (Lv.11-20) ---
            { id: 11, p:2, bpm: 100,r:0, s:0.13, d:16, snd:'click-4', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"ÈºìÂãï 100",s:"4ÂàÜÈü≥Á¨¶",o:"Ê°Å„ÅåÂ§â„Çè„ÇãÈÄüÂ∫¶„ÄÇ",a:"„Åì„Åì„Åã„Çâ„ÅåÊú¨Áï™„Åß„Åô„ÄÇ"}, en:{t:"Pulse 100",s:"Quarter",o:"Triple digits.",a:"Real game starts here."} },
            { id: 12, p:2, bpm: 100,r:0, s:0.12, d:16, snd:'click-8', pat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0], ja:{t:"ÁñæËµ∞ 100",s:"8ÂàÜÈü≥Á¨¶",o:"„É≠„ÉÉ„ÇØ„ÅÆÂü∫Êú¨„ÉÜ„É≥„Éù„ÄÇ",a:"Á∏¶„Éé„É™„ÅßÂàª„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇ"}, en:{t:"Drive 100",s:"8th Note",o:"Rock standard.",a:"Keep it vertical."} },
            { id: 13, p:2, bpm: 110,r:0, s:0.12, d:16, snd:'click-8', pat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0], ja:{t:"ÁñæËµ∞ 110",s:"8ÂàÜÈü≥Á¨¶",o:"Â∞ë„ÅóÈÄü„ÅÑÈÄ£Êâì„ÄÇ",a:"ËÑ±Âäõ„Åó„Å™„ÅÑ„Å®Èñì„Å´Âêà„ÅÑ„Åæ„Åõ„Çì„ÄÇ"}, en:{t:"Drive 110",s:"8th Note",o:"Faster flow.",a:"Relax to keep up."} },
            { id: 14, p:2, bpm: 120,r:0, s:0.12, d:16, snd:'click-8', pat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0], ja:{t:"ÁñæËµ∞ 120",s:"8ÂàÜÈü≥Á¨¶",o:"Ê®ôÊ∫ñÁöÑ„Å™„Ç¢„ÉÉ„Éó„ÉÜ„É≥„Éù„ÄÇ",a:"ÂëºÂê∏„ÇíÊ≠¢„ÇÅ„Å™„ÅÑ„Åß„ÄÇ"}, en:{t:"Drive 120",s:"8th Note",o:"Standard Up-tempo.",a:"Don't hold breath."} },
            { id: 15, p:2, bpm: 80, r:0, s:0.12, d:12, snd:'click-4', pat:[1,0,0,1,0,0,1,0,0,0,1,0,0,0,1,0], ja:{t:"16„Éì„Éº„Éà",s:"„Çø„ÉÉ„Éª„Ç´„ÉÉ",o:"16ÂàÜÈü≥Á¨¶„ÅÆË£è„ÄÇ",a:"„Äå„Çø„Éª„Ç´„Äç„ÅÆ„Äå„Ç´„Äç„ÅÆÈÉ®ÂàÜ„ÄÇ"}, en:{t:"16th Feel",s:"Syncopation",o:"The 'e' and 'a'.",a:"Feel the subdiv."} },
            { id: 16, p:2, bpm: 90, r:0, s:0.11, d:16, snd:'click-4', pat:[1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0], ja:{t:"„Éï„Ç°„É≥„ÇØ",s:"16ÂàÜÈü≥Á¨¶",o:"È£ü„ÅÜ„É™„Ç∫„É†„ÄÇ",a:"Ë∫´‰Ωì„ÇíÊè∫„Çâ„Åó„Å¶„É™„Ç∫„É†„ÇíÂèñ„Çã„ÄÇ"}, en:{t:"Funk",s:"16th Sync",o:"Anticipation.",a:"Move your body."} },
            { id: 17, p:2, bpm: 100,r:0, s:0.11, d:16, snd:'click-up-str', pat:[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0], ja:{t:"Ë£èÊãç 100",s:"Ë£èÊâì„Å°",o:"È´òÈÄü„Å™Ë£èÊâì„Å°„ÄÇ",a:"„Çπ„Ç´„ÇÑ„É¨„Ç≤„Ç®„ÅÆ„Ç§„É°„Éº„Ç∏„Åß„ÄÇ"}, en:{t:"Upbeat 100",s:"Off-beat",o:"Fast Off-beat.",a:"Ska/Reggae feel."} },
            { id: 18, p:2, bpm: 60, r:0, s:0.10, d:8,  snd:'click-4', pat:[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1], ja:{t:"„Éû„Ç∑„É≥„Ç¨„É≥",s:"16ÂàÜÈÄ£Êâì",o:"Ê≠£Á¢∫ÁÑ°ÊØî„Å™ÈÄ£Êâì„ÄÇ",a:"ÊåáÂÖà„ÅÆ„Ç≥„É≥„Éà„É≠„Éº„É´„ÄÇ"}, en:{t:"Machinegun",s:"16th Run",o:"Precision run.",a:"Finger control."} },
            { id: 19, p:2, bpm: 120,r:0, s:0.10, d:16, snd:'click-gap-2', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"Á©∫ÁôΩ 120",s:"Gap 2",o:"2Â∞èÁØÄÊ∂à„Åà„Åæ„Åô„ÄÇ",a:"‰ΩìÊÑüÊôÇÈñì„Çí‰ø°„Åò„Çã„ÄÇ"}, en:{t:"Void 120",s:"Gap 2",o:"2 Bars silence.",a:"Trust internal clock."} },
            { id: 20, p:2, bpm: 130,r:0, s:0.09, d:24, snd:'click-gap-4', pat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0], ja:{t:"P2‰øÆ‰∫ÜÊ§úÂÆö",s:"Gap 4",o:"8„Éì„Éº„Éà„ÅÆÂçíÊ•≠Ë©¶È®ì„ÄÇ",a:"„Ç¨„Ç§„Éâ„Å™„Åó„ÅßËµ∞„Çä„Åç„Çå„ÄÇ"}, en:{t:"P2 Exam",s:"Gap 4",o:"8-beat Final.",a:"Run without guide."} },

            // --- PHASE 3: SWING ENTRY (Lv.21-30) ---
            { id: 21, p:3, bpm: 100,r:0.33,s:0.12,d:16,snd:'click-4', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"„Çπ„Ç§„É≥„Ç∞ 100",s:"Shuffle",o:"„Åì„Åì„Åã„Çâ‰∏ñÁïå„ÅåÊ≠™„ÇÄ„ÄÇ",a:"3ÈÄ£Á¨¶„ÅÆÁúü„Çì‰∏≠„ÇíÊäú„ÅèÊÑüË¶ö„ÄÇ"}, en:{t:"Swing 100",s:"Shuffle",o:"World bends here.",a:"Triplet feel."} },
            { id: 22, p:3, bpm: 110,r:0.33,s:0.12,d:16,snd:'click-4', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"„Çπ„Ç§„É≥„Ç∞ 110",s:"Shuffle",o:"Ê•Ω„Åó„ÅÑË∑≥„Å≠„É™„Ç∫„É†„ÄÇ",a:"„Äå„Å£„Çø„ÄÅ„Å£„Çø„Äç„Å®Áô∫Èü≥„Åó„Å¶„ÄÇ"}, en:{t:"Swing 110",s:"Shuffle",o:"Bouncy rhythm.",a:"Say 'A-Ta, A-Ta'."} },
            { id: 23, p:3, bpm: 120,r:0.33,s:0.11,d:16,snd:'click-4', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"„Çπ„Ç§„É≥„Ç∞ 120",s:"Shuffle",o:"Ê®ôÊ∫ñÁöÑ„Å™„Ç∏„É£„Ç∫„ÉÜ„É≥„Éù„ÄÇ",a:"„É¨„Ç¨„Éº„ÉàÔºàÊªë„Çâ„ÅãÔºâ„Å´„ÄÇ"}, en:{t:"Swing 120",s:"Shuffle",o:"Standard Jazz.",a:"Play legato."} },
            { id: 24, p:3, bpm: 100,r:0.33,s:0.11,d:16,snd:'click-8', pat:[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0], ja:{t:"2„Éï„Ç£„Éº„É´",s:"2ÂàÜÈü≥Á¨¶",o:"„Éô„Éº„Çπ„É©„Ç§„É≥„ÅÆÊÑüË¶ö„ÄÇ",a:"1„Å®3ÊãçÁõÆ„ÇíÈáç„Åè„ÄÇ"}, en:{t:"2-Feel",s:"Half Note",o:"Bassline feel.",a:"Heavy on 1 & 3."} },
            { id: 25, p:3, bpm: 110,r:0.33,s:0.10,d:16,snd:'click-up-sw',pat:[0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0], ja:{t:"Ë£èÊâì„Å°SW",s:"SwingË£è",o:"„Çπ„Ç§„É≥„Ç∞„ÅÆË£èÊãç„ÅØÈÅÖ„ÅÑ„ÄÇ",a:"ÂçÅÂàÜ„Å´ÂæÖ„Å£„Å¶„Åã„ÇâÂè©„Åè„ÄÇ"}, en:{t:"Up-Swing",s:"Off-beat",o:"Swing off-beat is late.",a:"Wait for it."} },
            { id: 26, p:3, bpm: 120,r:0.33,s:0.10,d:16,snd:'click-8', pat:[1,0,0,0,0,0,1,0,1,0,0,0,0,0,1,0], ja:{t:"„ÉÅ„É£„Éº„É´„Çπ„Éà„É≥",s:"‰ªòÁÇπ4ÂàÜ",o:"„Ç∏„É£„Ç∫„ÅÆÂÖ∏ÂûãÁöÑ„É™„Ç∫„É†„ÄÇ",a:"„Äå„ÉÄ„ÉÉ„Éª„Éª„Ç¶„ÉÄ„ÉÉ„Éª„Éª„Äç"}, en:{t:"Charleston",s:"Dotted Q",o:"Classic Jazz.",a:"'Da.. (u)Da..'."} },
            { id: 27, p:3, bpm: 130,r:0.33,s:0.09,d:16,snd:'click-4', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"„Ç¶„Ç©„Éº„Ç≠„É≥„Ç∞",s:"4ÂàÜÈü≥Á¨¶",o:"ÈÄ≤ÊíÉ„ÅÆ„Éô„Éº„Çπ„É©„Ç§„É≥„ÄÇ",a:"Ââç„Å∏Ââç„Å∏„Å®ÈÄ≤„ÇÄÊé®ÈÄ≤Âäõ„ÄÇ"}, en:{t:"Walking",s:"Quarter",o:"Forward motion.",a:"Driving bass."} },
            { id: 28, p:3, bpm: 140,r:0.33,s:0.09,d:16,snd:'click-4', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"„Çπ„Ç§„É≥„Ç∞ 140",s:"4ÂàÜÈü≥Á¨¶",o:"Â∞ë„ÅóÊÅØ„ÅåÂàá„Çå„ÇãÈÄüÂ∫¶„ÄÇ",a:"Âäõ„ÇÄ„Å®ÈÅÖ„Çå„Åæ„Åô„ÄÇ"}, en:{t:"Swing 140",s:"Quarter",o:"Getting hot.",a:"Tension causes lag."} },
            { id: 29, p:3, bpm: 120,r:0.33,s:0.09,d:16,snd:'click-gap-2', pat:[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0], ja:{t:"Á©∫ÁôΩSW 120",s:"Gap 2",o:"„Çπ„Ç§„É≥„Ç∞„Åß„ÅÆÁ©∫ÈñìÊääÊè°„ÄÇ",a:"3ÈÄ£„ÅÆ„Ç∞„É™„ÉÉ„Éâ„ÇíÂøÉ„Å´„ÄÇ"}, en:{t:"Void SW 120",s:"Gap 2",o:"Swing space.",a:"Mental triplet grid."} },
            { id: 30, p:3, bpm: 130,r:0.33,s:0.08,d:24,snd:'click-gap-4', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"P3‰øÆ‰∫ÜÊ§úÂÆö",s:"Gap 4",o:"„Çπ„Ç§„É≥„Ç∞„ÅÆÂçíÊ•≠Ë©¶È®ì„ÄÇ",a:"„Ç¨„Ç§„Éâ„Å™„Åó„ÅßË∏ä„Çä„Åç„Çå„ÄÇ"}, en:{t:"P3 Exam",s:"Gap 4",o:"Swing Final.",a:"Dance without guide."} },

            // --- PHASE 4: ADVANCED (Lv.31-40) ---
            { id: 31, p:4, bpm: 150,r:0.33,s:0.08,d:24,snd:'click-4', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"„Éè„Éº„Éâ„Éê„ÉÉ„Éó",s:"Fast Swing",o:"ÁÜ±„ÅÑ„Ç∏„É£„Ç∫„ÅÆÂÖ•„ÇäÂè£„ÄÇ",a:"„Ç∑„É≥„Éê„É´„É¨„Ç¨„Éº„Éà„ÅÆ„Ç§„É°„Éº„Ç∏„ÄÇ"}, en:{t:"Hard Bop",s:"Fast Swing",o:"Hot Jazz entry.",a:"Ride cymbal image."} },
            { id: 32, p:4, bpm: 160,r:0.33,s:0.08,d:24,snd:'click-4', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"„Éê„Éº„Éã„É≥„Ç∞",s:"Fast Swing",o:"ÁáÉ„Åà„Çã„Çà„ÅÜ„Å™ÁñæËµ∞ÊÑü„ÄÇ",a:"ÊåáÂÖà„Å†„Åë„ÅßÂà∂Âæ°„Åô„Çã„ÄÇ"}, en:{t:"Burning",s:"Fast Swing",o:"Burning speed.",a:"Fingertip control."} },
            { id: 33, p:4, bpm: 170,r:0.33,s:0.07,d:24,snd:'click-4', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"„É™„Éü„ÉÉ„Éà",s:"Fast Swing",o:"ÊÄùËÄÉÂÅúÊ≠¢„ÅÆÈÄüÂ∫¶„ÄÇ",a:"ËÄÉ„Åà„Çã„Å™„ÄÅÊÑü„Åò„Çç„ÄÇ"}, en:{t:"Limit",s:"Fast Swing",o:"No thinking.",a:"Don't think, feel."} },
            { id: 34, p:4, bpm: 140,r:0.33,s:0.07,d:24,snd:'click-8', pat:[1,0,0,0,0,0,1,0,1,0,0,0,0,0,1,0], ja:{t:"Ë§áÈõë 140",s:"Syncopation",o:"È´òÈÄü„ÉÅ„É£„Éº„É´„Çπ„Éà„É≥„ÄÇ",a:"„Éë„Çø„Éº„É≥„ÇíË¶ãÂ§±„Çè„Å™„ÅÑ„Åß„ÄÇ"}, en:{t:"Complex 140",s:"Syncopation",o:"Fast Charleston.",a:"Stay focused."} },
            { id: 35, p:4, bpm: 90, r:0, s:0.07, d:16, snd:'click-16',pat:[1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0], ja:{t:"„Éù„É™„É™„Ç∫„É†",s:"3 over 4",o:"4ÊãçÂ≠ê„ÅÆ‰∏≠„ÅÆ3ÊãçÂ≠ê„ÄÇ",a:"1ÊãçÂçä„Åî„Å®„ÅÆ„Ç¢„ÇØ„Çª„É≥„Éà„ÄÇ"}, en:{t:"Polyrhythm",s:"3 over 4",o:"3 against 4.",a:"Every 1.5 beats."} },
            { id: 36, p:4, bpm: 150,r:0.33,s:0.07,d:24,snd:'click-gap-2', pat:[0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0], ja:{t:"Á©∫ÁôΩË£èSW",s:"Gap Off",o:"„Ç¨„Ç§„ÉâÁÑ°„Åó„ÅßË£èÊâì„Å°„ÄÇ",a:"Èõ£ÊòìÂ∫¶SÁ¥ö„ÅÆÂÖ•„ÇäÂè£„ÄÇ"}, en:{t:"Void Off",s:"Gap Off",o:"Blind off-beat.",a:"S-Tier entry."} },
            { id: 37, p:4, bpm: 180,r:0.33,s:0.06,d:32,snd:'click-4', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"„Éì„Éê„ÉÉ„Éó",s:"Very Fast",o:"‰ºùË™¨ÁöÑ„Å™ÈÄüÂ∫¶„ÄÇ",a:"ËÑ±Âäõ„Åó„Å™„ÅÑ„Å®ËÖï„ÅåÊ≠ª„Å´„Åæ„Åô„ÄÇ"}, en:{t:"Bebop",s:"Very Fast",o:"Legendary speed.",a:"Relax or die."} },
            { id: 38, p:4, bpm: 160,r:0.33,s:0.06,d:32,snd:'click-8', pat:[1,0,1,0,0,0,1,0,1,0,0,0,1,0,1,0], ja:{t:"„É©„É≥„Éã„É≥„Ç∞",s:"8th Lines",o:"È´òÈÄü„Éï„É¨„Éº„Ç∫„ÄÇ",a:"Á≤íÁ´ã„Å°„ÇíÊèÉ„Åà„Å¶„ÄÇ"}, en:{t:"Running",s:"8th Lines",o:"Fast lines.",a:"Keep it even."} },
            { id: 39, p:4, bpm: 100,r:0, s:0.06, d:16, snd:'click-gap-4', pat:[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0], ja:{t:"ÂÆåÂÖ®Á©∫ÁôΩ",s:"Gap 4 Off",o:"„Ç¨„Ç§„ÉâÁÑ°„Åó„ÄÅË£èÊãç„ÅÆ„Åø„ÄÇ",a:"Ëá™ÂàÜ„ÅÆ‰∏≠„ÅÆÁ•û„Çí‰ø°„Åò„Çç„ÄÇ"}, en:{t:"Total Void",s:"Gap 4 Off",o:"No guide, Off only.",a:"Trust your god."} },
            { id: 40, p:4, bpm: 160,r:0.33,s:0.05,d:32,snd:'click-gap-4', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"P4‰øÆ‰∫ÜÊ§úÂÆö",s:"Gap 4 Fast",o:"‰∏äÁ¥öËÄÖ„ÅÆÂ£Å„ÄÇ",a:"„Éó„É≠„É¨„Éô„É´„ÅÆÂÆâÂÆöÊÑü„ÅåÂøÖË¶Å„ÄÇ"}, en:{t:"P4 Exam",s:"Gap 4 Fast",o:"Pro Wall.",a:"Pro stability needed."} },

            // --- PHASE 5: GOD TIER (Lv.41-50) ---
            { id: 41, p:5, bpm: 190,r:0.33,s:0.05,d:32,snd:'click-4', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"Ë∂ÖÈ´òÈÄü 190",s:"Super Fast",o:"‰∫∫Èñì„ÅÆÈôêÁïå„Å´ÊåëÊà¶„ÄÇ",a:"„ÇÇ„ÅØ„ÇÑÂèçÂ∞ÑÁ•ûÁµå„ÅÆ„Ç≤„Éº„É†„ÄÇ"}, en:{t:"Hyper 190",s:"Super Fast",o:"Human limit.",a:"Reflex game."} },
            { id: 42, p:5, bpm: 200,r:0.33,s:0.05,d:32,snd:'click-4', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"Ë∂ÖÈ´òÈÄü 200",s:"Super Fast",o:"Êú™Áü•„ÅÆÈ†òÂüü„ÄÇ",a:"Áû¨„ÅçÂé≥Á¶Å„ÄÇ"}, en:{t:"Hyper 200",s:"Super Fast",o:"Unknown realm.",a:"Don't blink."} },
            { id: 43, p:5, bpm: 210,r:0.33,s:0.04,d:32,snd:'click-4', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"Ë∂ÖÈ´òÈÄü 210",s:"Super Fast",o:"Èü≥ÈÄü„ÇíË∂Ö„Åà„Å¶„ÄÇ",a:"Êåá„ÅåÂãùÊâã„Å´Âãï„ÅèÂ¢ÉÂú∞„ÄÇ"}, en:{t:"Hyper 210",s:"Super Fast",o:"Supersonic.",a:"Auto-pilot mode."} },
            { id: 44, p:5, bpm: 170,r:0.33,s:0.04,d:32,snd:'drum-only', pat:[1,0,0,0,0,0,1,0,1,0,0,0,0,0,1,0], ja:{t:"„Ç∏„É£„Ç∫„Éâ„É©„É†",s:"Comping",o:"„Éâ„É©„É†„Å®„ÅÆÂØæË©±„ÄÇ",a:"„ÇØ„É™„ÉÉ„ÇØÈü≥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ"}, en:{t:"Jazz Drums",s:"Comping",o:"Trade w/ drums.",a:"No click track."} },
            { id: 45, p:5, bpm: 180,r:0.33,s:0.04,d:32,snd:'drum-only', pat:[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0], ja:{t:"Ë£è„ÅÆÊ•µÊÑè",s:"Upbeat Only",o:"„Éâ„É©„É†„Å´Âêà„Çè„Åõ„Å¶Ë£è„ÇíÂè©„Åè„ÄÇ",a:"Á©∂Ê•µ„ÅÆ„Ç∞„É´„Éº„É¥„ÄÇ"}, en:{t:"Upbeat Master",s:"Upbeat Only",o:"Groove w/ drums.",a:"Ultimate groove."} },
            { id: 46, p:5, bpm: 140,r:0.33,s:0.04,d:32,snd:'click-gap-4', pat:[1,0,0,1,0,0,1,0,1,0,0,1,0,0,1,0], ja:{t:"ÂøÉÁúº",s:"Blind Funk",o:"Ë¶ã„Åà„Å™„ÅÑ„É™„Ç∫„É†„ÇíÂè©„Åè„ÄÇ",a:"ÂøÉ„ÅÆÁõÆ„ÅßË¶ã„Çã„ÄÇ"}, en:{t:"Mind's Eye",s:"Blind Funk",o:"Hit invisible.",a:"See with mind."} },
            { id: 47, p:5, bpm: 60, r:0, s:0.03, d:16, snd:'click-gap-4', pat:[1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0], ja:{t:"Á¶Ö",s:"Zen Space",o:"Ê∞∏ÈÅ†„ÅÆ„Çà„ÅÜ„Å™Á©∫Èñì„ÄÇ",a:"ÂæÖ„Å§„Åì„Å®„ÅÆÊ•µËá¥„ÄÇ"}, en:{t:"Zen",s:"Zen Space",o:"Eternal space.",a:"Master of waiting."} },
            { id: 48, p:5, bpm: 220,r:0.33,s:0.04,d:48,snd:'click-4', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"ÂÖâÈÄü 220",s:"Light Speed",o:"ÊÄùËÄÉ„ÅÆÂêë„Åì„ÅÜÂÅ¥„ÄÇ",a:"ÁÑ°ÂøÉ„ÄÇ"}, en:{t:"Lightspeed",s:"Light Speed",o:"Beyond thought.",a:"No mind."} },
            { id: 49, p:5, bpm: 240,r:0.33,s:0.04,d:48,snd:'click-4', pat:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0], ja:{t:"ÁâπÁï∞ÁÇπ",s:"Singularity",o:"„É™„Ç∫„É†„ÅÆÂ¥©Â£ä„Å®ÂÜçÁîü„ÄÇ",a:"ÂÖ®„Å¶„ÇíÂá∫„ÅóÂàá„Çå„ÄÇ"}, en:{t:"Singularity",s:"Singularity",o:"Collapse & Rebirth.",a:"Give everything."} },
            { id: 50, p:5, bpm: 180,r:0.33, s:0.03, d:64, snd:'drum-only', pat:[1,-1,1,-1,1,-1,1,-1,1,-1,1,-1,1,-1,1,-1], ja:{t:"THE LEGEND",s:"ÂÆå ÂÖ® Âà∂ Ë¶á",o:"ÂÖçË®±ÁöÜ‰ºù„ÄÇ",a:"Enjoy Music."}, en:{t:"THE LEGEND",s:"GOD",o:"Mastery.",a:"Enjoy Music."} }
        ];

        // --- 3. SYSTEM VARIABLES ---
        let audioCtx, noiseBuffer;
        let isPlaying = false, isDemo = false, chartInstance = null;
        let currentLesson = null;
        let nextNoteTime = 0, noteIndex = 0;
        let notes = [], hitHistory = [];
        let progress = { passed: [], stats: {} };
        let animationId;
        const SAVE_KEY = 'jrt_save_v5';
        const OFFSET_KEY = 'jrt_offset';

        let userOffset = 0.06;
        
        let isCalibrating = false;
        let calibNextTime = 0;
        let calibCount = 0;
        let calibTimerId = null;
        const CALIB_BPM = 100;
        const CALIB_ALPHA = 0.1;

        // --- 4. CORE FUNCTIONS ---
        function setLang(l) {
            lang = l;
            // „É¶„Éº„Ç∂„Éº„Ç¢„ÇØ„Ç∑„Éß„É≥„Çí„Éà„É™„Ç¨„Éº„Å´AudioContext„ÇíÂàùÊúüÂåñ
            initAudio(); 
            
            // „Çø„Ç§„Éà„É´ÁîªÈù¢„Çí„Éï„Çß„Éº„Éâ„Ç¢„Ç¶„Éà
            document.getElementById('title-screen').style.opacity = 0;
            
            setTimeout(() => {
                document.getElementById('title-screen').style.display = 'none';
                document.getElementById('main-header').style.display = 'flex';
                document.getElementById('app-footer').style.display = 'block';

                // ‚òÖ„Äê‰øÆÊ≠£ÁÇπ„Äë„Éá„Éº„Çø„ÅÆÊúâÁÑ°„ÅßÂàÜÂ≤ê„Åï„Åõ„Çã
                if (!localStorage.getItem(OFFSET_KEY)) {
                    // „Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà -> ÂàùÊúüË®≠ÂÆö(„Ç≠„É£„É™„Éñ„É¨„Éº„Ç∑„Éß„É≥)„Å∏
                    showWelcome();
                } else {
                    // „Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà -> „É°„Éã„É•„Éº„Å∏
                    renderMenu();
                }
            }, 500);
        }

        function updateTexts() {
            const t = TEXT[lang];
            document.getElementById('menu-title').innerText = t.menuTitle;
            document.getElementById('menu-desc').innerText = t.menuDesc;
            document.getElementById('btn-reset-data').innerText = t.reset;
            document.getElementById('btn-play-demo').innerHTML = t.demo;
            document.getElementById('btn-start-session').innerText = t.start;
            document.getElementById('btn-cancel-brief').innerText = t.cancel;
            document.getElementById('stats-title').innerText = t.statsTitle;
            document.getElementById('help-title').innerText = t.helpTitle;
            document.getElementById('help-content').innerHTML = t.helpContent;
            document.getElementById('close-help').innerText = t.cancel;
            document.getElementById('close-stats').innerText = t.cancel;
        }

        function loadSave() {
            const d = localStorage.getItem(SAVE_KEY);
            if(d) progress = JSON.parse(d);
            if(!progress.stats) progress.stats = {};
            const o = localStorage.getItem(OFFSET_KEY);
            if(o) userOffset = parseFloat(o);
        }
        function saveProgress() { localStorage.setItem(SAVE_KEY, JSON.stringify(progress)); }
        function resetSave() {
            if(confirm(TEXT[lang].resetConfirm)) {
                localStorage.removeItem(SAVE_KEY);
                progress = { passed: [], stats: {} };
                renderMenu();
            }
        }

        // --- 5. AUDIO ENGINE ---
        function initAudio() {
            if(!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext({ latencyHint: 'interactive', sampleRate: 44100 });
            }
            if(audioCtx.state === 'suspended') audioCtx.resume();
            if(!noiseBuffer) {
                const b = audioCtx.createBuffer(1, audioCtx.sampleRate * 2, audioCtx.sampleRate);
                const d = b.getChannelData(0);
                for(let i=0; i<d.length; i++) d[i] = Math.random() * 2 - 1;
                noiseBuffer = b;
            }
        }

        function playSound(type, time, vol=1.0) {
            if(!audioCtx) return;
            const t = Math.max(audioCtx.currentTime, time);
            const master = audioCtx.createGain(); master.gain.value=1.0; master.connect(audioCtx.destination);

            if(type === 'click' || type === 'count') {
                const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
                osc.frequency.setValueAtTime(type==='count'?1000:800, t);
                osc.frequency.exponentialRampToValueAtTime(100, t+0.1);
                g.gain.setValueAtTime(0.7*vol, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.05);
                osc.connect(g); g.connect(master); osc.start(t); osc.stop(t+0.1);
            } else if(type === 'ride') {
                [320, 460, 680, 940].forEach((f,i)=>{
                    const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
                    o.type='square'; o.frequency.value=f; o.detune.value=Math.random()*20-10;
                    g.gain.setValueAtTime((0.03/(i+1))*vol,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.4);
                    const h=audioCtx.createBiquadFilter(); h.type='highpass'; h.frequency.value=3000;
                    o.connect(g); g.connect(h); h.connect(master); o.start(t); o.stop(t+0.5);
                });
                const n=audioCtx.createBufferSource(); n.buffer=noiseBuffer;
                const ng=audioCtx.createGain(); const nf=audioCtx.createBiquadFilter();
                nf.type='bandpass'; nf.frequency.value=8000;
                ng.gain.setValueAtTime(0.3*vol,t); ng.gain.exponentialRampToValueAtTime(0.001,t+(vol>0.8?0.8:0.4));
                n.connect(nf); nf.connect(ng); ng.connect(master); n.start(t); n.stop(t+1.0);
            } else if(type === 'hihat') {
                const n=audioCtx.createBufferSource(); n.buffer=noiseBuffer;
                const nf=audioCtx.createBiquadFilter(); nf.type='highpass'; nf.frequency.value=7000;
                const ng=audioCtx.createGain(); ng.gain.setValueAtTime(0.6*vol,t); ng.gain.exponentialRampToValueAtTime(0.001,t+0.06);
                n.connect(nf); nf.connect(ng); ng.connect(master); n.start(t); n.stop(t+0.1);
            } else if(type === 'kick') {
                const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
                o.frequency.setValueAtTime(120,t); o.frequency.exponentialRampToValueAtTime(50,t+0.15);
                g.gain.setValueAtTime(0.8*vol,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.25);
                o.connect(g); g.connect(master); o.start(t); o.stop(t+0.3);
            } else if(type === 'guide') {
                const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
                o.type='sine'; o.frequency.value=880; g.gain.setValueAtTime(0.1*vol,t); g.gain.linearRampToValueAtTime(0,t+0.1);
                o.connect(g); g.connect(master); o.start(t); o.stop(t+0.1);
            }
        }

        // --- 6. GAME LOGIC ---
        function getSwingTime(base, sixteenth, bpm, ratio) {
            const secPer16 = (60/bpm)/4;
            const mod = sixteenth % 4;
            let dr = ratio;
            if(ratio > 0) dr = 0.25 + (0.12 * Math.max(0, Math.min(1, (300-bpm)/200)));
            if(mod === 2 || mod === 3) return base + (secPer16 * dr * 1.8);
            return base;
        }

        function schedule() {
            if(!isPlaying) return;
            const bpm = currentLesson.bpm;
            const secPer16 = (60/bpm)/4;
            const total16ths = currentLesson.d * 16;
            
            while(nextNoteTime < audioCtx.currentTime + 0.1) {
                if(isDemo && noteIndex >= 64) { stopDemo(); return; }
                if(!isDemo && noteIndex >= total16ths) { finishLesson(); return; }

                const bar = Math.floor(noteIndex / 16);
                const sixteenth = noteIndex % 16;
                const actualTime = getSwingTime(nextNoteTime, sixteenth, bpm, currentLesson.r);
                
                const st = currentLesson.snd;
                let isGap = false;
                if(st.includes('gap-4') && (bar+1)%4===0) isGap=true;
                if(st.includes('gap-2') && bar%4>=2) isGap=true;

                if(!isGap || isDemo) {
                    let click=false;
                    if(!isGap) {
                        if(st==='click-4' && sixteenth%4===0) click=true;
                        else if(st==='click-8' && sixteenth%2===0) click=true;
                        else if((st==='click-up-str'||st==='click-up-sw') && sixteenth%4===2) click=true;
                        else if((st==='click-24'||st.includes('gap')) && (sixteenth===4||sixteenth===12)) click=true;
                    }
                    if(click) playSound('click', actualTime, 0.8);

                    if(currentLesson.r > 0 && !st.includes('click-up')) {
                        if(sixteenth===4||sixteenth===12) playSound('hihat', actualTime, 0.7);
                        if(sixteenth===0||sixteenth===8) playSound('ride', actualTime, 0.7);
                        if(sixteenth===6||sixteenth===14) playSound('ride', actualTime, 0.85);
                        if(sixteenth===0||sixteenth===8) playSound('kick', actualTime, 0.5);
                    }
                }

                const pVal = currentLesson.pat[sixteenth];
                if(pVal !== 0) {
                    if(isDemo) playSound('guide', actualTime);
                    notes.push({ time:actualTime, type:pVal, processed:false, angle:(sixteenth/16)*Math.PI*2 - Math.PI/2 });
                }
                nextNoteTime += secPer16;
                noteIndex++;
            }
            setTimeout(schedule, 20);
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        function resize() { canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        function draw() {
            if(!isPlaying && !document.getElementById('countdown-overlay').innerHTML) return;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            const cx=canvas.width/2, cy=canvas.height/2;
            const r=Math.min(cx,cy)*0.55;
            const now=audioCtx?audioCtx.currentTime:0;

            // Radar
            ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.strokeStyle="rgba(255,255,255,0.1)"; ctx.lineWidth=4; ctx.stroke();
            for(let i=0;i<4;i++){
                const a=i*(Math.PI/2)-Math.PI/2;
                ctx.beginPath(); ctx.moveTo(cx+Math.cos(a)*(r-10),cy+Math.sin(a)*(r-10));
                ctx.lineTo(cx+Math.cos(a)*(r+10),cy+Math.sin(a)*(r+10));
                ctx.strokeStyle=i===0?"var(--accent)":"rgba(255,255,255,0.3)"; ctx.stroke();
            }

            if(isPlaying) {
                const ph = ((now*currentLesson.bpm/240)%1)*Math.PI*2 - Math.PI/2;
                ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+Math.cos(ph)*r, cy+Math.sin(ph)*r);
                ctx.strokeStyle=isDemo?"#aaa":"var(--accent)"; ctx.lineWidth=2; ctx.stroke();

                const linearY = cy+r+80;
                notes.forEach(n => {
                    if(n.processed) return;
                    const diff = n.time - now;
                    if(!isDemo && diff < -0.15) { n.processed=true; hitHistory.push({diff:null, type:'miss'}); showFeedback("MISS","#555"); }
                    if(isDemo && diff < -0.05) n.processed=true;
                    
                    if(diff>0 && diff<(60/currentLesson.bpm)*4) {
                        const alpha = 1-(diff/((60/currentLesson.bpm)*4));
                        ctx.fillStyle=n.type===1?"#f72585":"#4cc9f0"; ctx.globalAlpha=alpha;
                        ctx.beginPath(); ctx.arc(cx+Math.cos(n.angle)*r, cy+Math.sin(n.angle)*r, 10, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha=1;
                    }
                    const lx = cx+(diff*300);
                    if(lx>0 && lx<canvas.width) {
                        ctx.fillStyle=n.type===1?"#f72585":"#4cc9f0";
                        ctx.beginPath(); ctx.arc(lx, linearY, 12, 0, Math.PI*2); ctx.fill();
                    }
                });
                
                if(!isDemo) {
                    ctx.beginPath(); ctx.moveTo(cx,linearY-30); ctx.lineTo(cx,linearY+30); ctx.strokeStyle="#fff"; ctx.stroke();
                    const el = Math.max(0, now - (notes[0]?notes[0].time:0)+2);
                    document.getElementById('hud-time').innerText = Math.floor(el/60)+":"+Math.floor(el%60).toString().padStart(2,'0');
                } else document.getElementById('hud-time').innerText = "DEMO";
            }
            animationId = requestAnimationFrame(draw);
        }

        // --- 7. INPUT & FEEDBACK ---
        function handleInput(type) {
            if(isCalibrating) {
                handleCalibrationTap();
                return;
            }

            if(!isPlaying || isDemo) return;
            const now = audioCtx.currentTime;
            
            const osc=audioCtx.createOscillator(); const g=audioCtx.createGain();
            osc.frequency.value=800; g.gain.setValueAtTime(0.1,now); g.gain.exponentialRampToValueAtTime(0.001,now+0.1);
            osc.connect(g); g.connect(audioCtx.destination); osc.start(now); osc.stop(now+0.1);

            let best=999, target=null;
            const effectiveInputTime = now - userOffset;

            notes.forEach(n => {
                if(n.processed || n.type !== type) return;
                const d = Math.abs(effectiveInputTime - n.time);
                if(d < best) { best = d; target = n; }
            });

            if(target && best < currentLesson.s) {
                target.processed = true;
                const diff = effectiveInputTime - target.time;
                hitHistory.push({diff:diff, type:'hit'});
                const ms = Math.round(diff*1000);
                const isP = Math.abs(ms) < 30;
                showFeedback(isP?"PERFECT":ms+"ms", isP?"#0ff":(ms>0?"#f09":"#ff0"));
            }
        }

        function showFeedback(t,c) {
            const el = document.getElementById('feedback-float');
            el.innerText = t; el.style.color = c; el.style.opacity = 1;
            setTimeout(()=>el.style.opacity=0, 200);
        }

        function finishLesson() {
            isPlaying = false; document.body.classList.remove('playing');
            const hits = hitHistory.filter(h=>h.type==='hit');
            const total = hits.length + hitHistory.filter(h=>h.type==='miss').length;
            if(total===0) { showResult('F',0,0,"No Input"); return; }
            
            const sum = hits.reduce((a,b)=>a+b.diff,0);
            const mean = sum/hits.length * 1000;
            const variance = hits.reduce((a,b)=>a+Math.pow((b.diff*1000)-mean,2),0)/hits.length;
            const sd = Math.sqrt(variance);

            let grade="F", msg="FAILED", passed=false;
            const limit = currentLesson.p === 1 ? 60 : (currentLesson.p >= 4 ? 40 : 50);

            if (hits.length > total*0.8 && sd < limit) {
                if(sd<20 && Math.abs(mean)<20) { grade="S"; msg="GODLIKE"; passed=true; }
                else if(sd<35) { grade="A"; msg="EXCELLENT"; passed=true; }
                else { grade="B"; msg="PASSED"; passed=true; }
            } else msg = "UNSTABLE";

            if(passed) {
                if(!progress.passed.includes(currentLesson.id)) progress.passed.push(currentLesson.id);
                progress.stats[currentLesson.id] = { bias: Math.round(mean), sd: Math.round(sd) };
                saveProgress();
            }
            showResult(grade, Math.round(mean), Math.round(sd), msg);
        }

        // --- 8. UI CONTROLLERS & CALIBRATION ---
        function showModal(id) { document.querySelectorAll('.modal-overlay').forEach(e=>e.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function hideModals() { document.querySelectorAll('.modal-overlay').forEach(e=>e.classList.remove('active')); }
        
        // WELCOME & FIRST SETUP
        function showWelcome() {
            showModal('modal-welcome');
        }
        function closeWelcome() {
            hideModals();
        }
        function startCalibrationFromWelcome() {
            initAudio();
            closeWelcome();
            startCalibration();
        }

        // CALIBRATION
        function startCalibration() {
            initAudio();
            isCalibrating = true;
            calibNextTime = audioCtx.currentTime + 0.5;
            calibCount = 0;
            document.getElementById('calib-offset-val').innerText = Math.round(userOffset * 1000);
            showModal('modal-calibration');
            scheduleCalibration();
        }

        function scheduleCalibration() {
            if(!isCalibrating) return;
            const interval = 60 / CALIB_BPM;
            
            while(calibNextTime < audioCtx.currentTime + 0.1) {
                playSound('click', calibNextTime);
                const t = calibNextTime;
                setTimeout(() => {
                    if(!isCalibrating) return;
                    const el = document.getElementById('calib-visual');
                    el.classList.add('flash');
                    setTimeout(()=>el.classList.remove('flash'), 50);
                }, (t - audioCtx.currentTime)*1000);
                
                calibNextTime += interval;
                calibCount++;
            }
            calibTimerId = setTimeout(scheduleCalibration, 50);
        }

        function stopCalibrationLoop() {
            isCalibrating = false;
            if(calibTimerId) clearTimeout(calibTimerId);
            calibTimerId = null;
        }

        function handleCalibrationTap() {
            if(!isCalibrating) return;
            const now = audioCtx.currentTime;
            const interval = 60 / CALIB_BPM;
            const lastBeat = calibNextTime - interval;
            const nextBeat = calibNextTime;
            const distLast = Math.abs(now - lastBeat);
            const distNext = Math.abs(now - nextBeat);
            let targetTime = (distLast < distNext) ? lastBeat : nextBeat;
            
            let rawDiff = now - targetTime;
            if(Math.abs(rawDiff) > 0.3) return;

            userOffset = (userOffset * (1 - CALIB_ALPHA)) + (rawDiff * CALIB_ALPHA);
            document.getElementById('calib-offset-val').innerText = Math.round(userOffset * 1000);
            
            const osc=audioCtx.createOscillator(); const g=audioCtx.createGain();
            osc.frequency.value=1200; g.gain.setValueAtTime(0.1,now); g.gain.exponentialRampToValueAtTime(0.001,now+0.05);
            osc.connect(g); g.connect(audioCtx.destination); osc.start(now); osc.stop(now+0.05);
        }

        function saveCalibration() {
            stopCalibrationLoop();
            localStorage.setItem(OFFSET_KEY, userOffset.toFixed(5));
            hideModals();
            // ‚òÖ„Äê‰øÆÊ≠£ÁÇπ„ÄëË®≠ÂÆöÂÆå‰∫ÜÂæå„Å´„É°„Éã„É•„Éº„ÇíÈñã„Åè
            renderMenu();
        }

        function cancelCalibration() {
            stopCalibrationLoop();
            loadSave();
            hideModals();
            // „Ç≠„É£„É≥„Çª„É´ÊôÇ„ÇÇ„É°„Éã„É•„Éº„Å∏ÔºàÂàùÂõû„Åß„Å™„Åë„Çå„Å∞Ôºâ
            if(localStorage.getItem(OFFSET_KEY)) renderMenu();
            else showWelcome(); // „Éá„Éº„Çø„Å™„Åë„Çå„Å∞Êàª„Çã
        }

        function prepareLesson(id) {
            currentLesson = LESSON_DATA.find(l=>l.id===id);
            const c = currentLesson[lang];
            document.getElementById('brief-title').innerText = `LESSON ${id} : ${c.t}`;
            document.getElementById('brief-obj').innerText = c.o;
            document.getElementById('brief-advice').innerText = c.a;
            document.getElementById('brief-bpm').innerText = currentLesson.bpm;
            document.getElementById('brief-swing').innerText = currentLesson.r>0?"ON":"OFF";
            isDemo=false; isPlaying=false; hideModals(); showModal('modal-briefing');
        }

        function showResult(g,m,s,msg) {
            showModal('modal-result');
            const gel = document.getElementById('res-grade');
            gel.innerText=g; gel.className=`big-grade grade-${g}`;
            document.getElementById('res-msg').innerText = msg;
            document.getElementById('res-bias').innerText = (m>0?"+":"")+m+"ms";
            document.getElementById('res-sd').innerText = "¬±"+s+"ms";
            
            const btn = document.getElementById('btn-next');
            if(g==='F') { btn.innerText = TEXT[lang].retry; btn.onclick = () => prepareLesson(currentLesson.id); }
            else {
                if(currentLesson.id < 50) { btn.innerText = TEXT[lang].next; btn.onclick = () => prepareLesson(currentLesson.id+1); }
                else { btn.innerText = TEXT[lang].menu; btn.onclick = renderMenu; }
            }
        }

        function renderMenu() {
            updateTexts();
            const list = document.getElementById('lesson-list'); list.innerHTML = "";
            showModal('modal-menu');
            let lp = 0;
            LESSON_DATA.forEach((l, i) => {
                if(l.p !== lp) {
                    const h = document.createElement('div'); h.className = 'phase-header';
                    h.innerText = TEXT[lang].phases[l.p-1]; list.appendChild(h); lp = l.p;
                }
                const pass = progress.passed.includes(l.id);
                const lock = (i>0 && !progress.passed.includes(LESSON_DATA[i-1].id));
                const d = document.createElement('div');
                d.className = `lesson-card ${lock?'locked':''} p${l.p}`;
                d.innerHTML = `
                    <div style="flex:1;">
                        <div style="display:flex; align-items:center;">
                            <span class="lvl-badge">L.${l.id}</span>
                            <span style="font-weight:bold; color:#fff; font-size:0.9rem;">${l[lang].t}</span>
                        </div>
                        <div style="font-size:0.7rem; color:#888; margin-top:4px; margin-left:60px;">${l[lang].s}</div>
                    </div>
                    <div class="status-badge ${pass?'passed':''}">${lock?'LOCK':(pass?'CLEAR':'START')}</div>
                `;
                d.onclick = () => { if(!lock) prepareLesson(l.id); };
                list.appendChild(d);
            });

            // ‚òÖ ËøΩÂä†: „É°„Éã„É•„ÉºË°®Á§∫„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„Åß„Ç≠„É£„É™„Éñ„É¨„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„ÇíÁôªÈå≤
            const calibBtn = document.getElementById('btn-calib');
            if(calibBtn) calibBtn.onclick = startCalibration;
        }
        function toggleDemo() {
            if(isPlaying && isDemo) stopDemo();
            else {
                initAudio();
                document.getElementById('btn-play-demo').innerHTML = TEXT[lang].stopDemo;
                document.getElementById('btn-play-demo').classList.add('playing');
                isDemo=true; isPlaying=true; notes=[]; noteIndex=0; nextNoteTime=audioCtx.currentTime+0.5;
                draw(); schedule();
            }
        }
        function stopDemo() {
            isPlaying=false; isDemo=false;
            document.getElementById('btn-play-demo').innerHTML = TEXT[lang].demo;
            document.getElementById('btn-play-demo').classList.remove('playing');
            cancelAnimationFrame(animationId); ctx.clearRect(0,0,canvas.width,canvas.height);
        }

        // --- 9. STARTUP ---
        loadSave();
        document.getElementById('btn-help').onclick=()=>showModal('modal-help');
        document.getElementById('close-help').onclick=()=>showModal('modal-menu');
        
        // ‚òÖ ÂâäÈô§: „Åì„Åì„Å´„ÅÇ„Å£„Åü btn-calib „ÅÆÁôªÈå≤„ÅØ renderMenu ÂÜÖ„Å∏ÁßªÂãï„Åó„Åæ„Åó„Åü

        document.getElementById('btn-stats').onclick=()=>{ updateTexts(); showModal('modal-stats'); renderChart(); };
        document.getElementById('close-stats').onclick=()=>showModal('modal-menu');
        document.getElementById('btn-play-demo').onclick=toggleDemo;
        document.getElementById('btn-start-session').onclick=()=>{
            if(isDemo) stopDemo(); initAudio(); hideModals(); document.body.classList.add('playing');
            const ce=document.getElementById('countdown-text');
            const beat=60/currentLesson.bpm;
            document.getElementById('hud-status').innerText=`LESSON ${currentLesson.id}`;
            notes=[]; hitHistory=[]; noteIndex=0; draw();
            let c=4;
            function tick(){
                if(c>0) { ce.innerText=c; ce.className='count-anim'; playSound('count',audioCtx.currentTime); setTimeout(()=>ce.className='',beat*900); setTimeout(tick,beat*1000); c--; }
                else { ce.innerText="GO!"; ce.className='count-anim'; playSound('kick',audioCtx.currentTime); setTimeout(()=>{ ce.innerText=""; isPlaying=true; nextNoteTime=audioCtx.currentTime; schedule(); },beat*1000); }
            }
            tick();
        };
        document.getElementById('btn-cancel-brief').onclick=()=>{ if(isDemo) stopDemo(); renderMenu(); };
        document.getElementById('btn-reset-data').onclick=resetSave;
        
        // „Ç≠„Éº„Éú„Éº„ÉâÊìç‰Ωú
        document.addEventListener('keydown', e=>{ if(e.key==='x'||e.key==='ArrowUp') handleInput(1); if(e.key==='z'||e.key==='ArrowDown') handleInput(-1); });
        
        // ‚òÖ Êï¥ÁêÜÊ∏à„Åø: „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„ÉàÔºàÈáçË§áÂâäÈô§„Åó„ÄÅ„Åì„Çå1„Å§„ÅÆ„Åø„Å´„Åó„Åæ„ÅôÔºâ
        document.addEventListener('touchstart', e=>{ 
            if(isCalibrating && e.target.closest('#modal-calibration')) {
                e.preventDefault();
                handleCalibrationTap();
            }
            else if(e.target.tagName==='CANVAS'){ 
                e.preventDefault(); 
                handleInput(e.touches[0].clientY<window.innerHeight/2?1:-1); 
            } 
        }, {passive:false});

        function renderChart() {
            const c=document.getElementById('statsChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            const l=[], d=[];
            LESSON_DATA.forEach(x=>{ if(progress.passed.includes(x.id)&&progress.stats[x.id]){ l.push(x.id); d.push(progress.stats[x.id].bias); } });
            if(l.length===0){ l.push(0); d.push(0); }
            chartInstance = new Chart(c, {
                type:'line', data:{ labels:l, datasets:[{ label:'Bias(ms)', data:d, borderColor:'#4cc9f0', tension:0.3, pointRadius:3 }] },
                options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{display:false}, y:{ suggestedMin:-50, suggestedMax:50, grid:{color:'#333'} } }, plugins:{legend:{display:false}} }
            });
        }
        
        // ÂàùÂõûËµ∑Âãï„ÉÅ„Çß„ÉÉ„ÇØ
        if(!localStorage.getItem(OFFSET_KEY)) {
            showWelcome();
        }

        // Ëá™ÂãïÂÆüË°å„É≠„Ç∏„ÉÉ„ÇØ„ÅØÂâäÈô§Ê∏à„ÅøÔºàsetLangÂÜÖ„ÅßÂà§ÂÆö„Åô„Çã„Åü„ÇÅ‰∏çË¶ÅÔºâ
    </script>
</body>
</html>